# モジュールに依存オブジェクトを提供する

プロバイダーは依存性がある値を取り出す方法を[Dependency Injection](/guide/dependency-injection)システムへ指示します。ほとんどの場合、これらの依存性はあなたが作成して提供するサービスによるものです。

この記事で説明されているプロバイダーを含む最終的なサンプルアプリケーションについては、
<live-example></live-example>を参照してください。

## サービスを提供する

すでに[Angular CLI](cli)で生成したアプリケーションがある場合は、 [`ng generate`](cli/generate) CLIコマンドをプロジェクトのルートディレクトリで実行してサービスを生成できます。 _User_はあなたの好きなサービス名に置きかえてかまいません。

```sh
ng generate service User
```

このコマンドによって次のような`UserService`スケルトンが作成されます:

<code-example path="providers/src/app/user.service.0.ts"  header="src/app/user.service.ts"></code-example>

あなたはいま、`UserService`をアプリケーションのどこにでも注入することができます。

サービス自体はCLIが生成したクラスであり、`@Injectable()` デコレーターが付与されます。デフォルトでは、このデコレーターには`provideIn`プロパティが設定されサービスのプロバイダーを作成します。このケースでは、`provideIn： 'root'`は Angularがサービスをルートインジェクターに提供すべきであることを指定しています。


## プロバイダーのスコープ

ルートアプリケーションインジェクターにサービスプロバイダーを追加すると、それはアプリケーション全体で使用することができます。さらに、それらのプロバイダーは、ルックアップトークンを持っている限り、アプリ内のすべてのクラスで利用可能です。

利用者が特定の`@NgModule`をインポートした場合にのみサービスを利用できるようにしたい場合を除いて、ルートインジェクターでサービスを提供すべきです。

## `providedIn` と NgModule

特定の`@NgModule`内でサービスを提供するように指定することもできます。たとえば、あなたが作成した`UserModule`をインポートしない限り`UserService`をアプリケーションで利用できないようにモジュール内でサービスを提供するように指定できます:

<code-example path="providers/src/app/user.service.1.ts"  header="src/app/user.service.ts"></code-example>

上記の例では、モジュールにサービスを提供する推奨の方法を示しています。この方法を使用すると、サービスがどこからも注入されないときに、ツリーシェイキングの対象にできるので推奨されます。どのモジュールがサービスを提供すべきかをそのサービス内で指定できない場合は、モジュール内でそのサービスのプロバイダーを宣言することもできます:

<code-example path="providers/src/app/user.module.ts"  header="src/app/user.module.ts"></code-example>

## 遅延ロードモジュールでプロバイダーのスコープを制限する {@a limiting-provider-scope-by-lazy-loading-modules}

基本的に、CLIで生成されたアプリケーションでは、モジュールは即時ロードされます(つまり、アプリケーションの起動時にすべてロードされます)。Angularはインジェクターシステムを使用してモジュール間でのやりとりを可能にします。即時ロードされたアプリケーションでは、ルートアプリケーションインジェクターは、すべてのモジュールのすべてのプロバイダーをアプリケーション全体で利用可能にします。

この動作は、遅延ロードを使用すると必然的に変わってしまいます。遅延ロードとは、モジュールが必要になったときだけロードすることです。たとえば、ルーティングするときなどです。それらは即時ロードされるモジュールのようにすぐにロードされることはありません。つまり、ルートインジェクターはこれら遅延ロードされるモジュールについて認識しないため、そのモジュール内のプロバイダーの配列にリストされているサービスは使用できません。

<!-- KW--Make diagram here -->
<!-- KW--per Misko: not clear if the lazy modules are siblings or grand-children. They are both depending on router structure. -->
Angularルーターがモジュールを遅延ロードすると、新しいインジェクターが作成されます。このインジェクターは、ルートアプリケーションインジェクターの子供となります。インジェクターのツリーを想像してみてください。単一のルートインジェクターと、個々の遅延ロードされるモジュールのための子インジェクターがあります。ルーターはルートインジェクターから子インジェクターにすべてのプロバイダーを追加します。ルーターが遅延ロードされたモジュールのコンテキスト内でコンポーネントを作成するとき、Angularはルートインジェクターのサービスインスタンスよりも、それらのプロバイダーで作成されたサービスインスタンスを優先します。

遅延ロードされたモジュールのコンテキスト内で作成されたコンポーネント(ルーターのナビゲーションなど)は、ルートアプリケーションインジェクターのインスタンスではなく、サービスのローカルインスタンスを取得します。外部モジュール内のコンポーネントは、アプリケーションルート用に作成されたインスタンスを受け取り続けます。

遅延ロードするモジュールでサービスを提供することはできますが、すべてのサービスを遅延ロードすることはできません。たとえば、ルーターなど、ルートモジュールでのみ機能するモジュールもあります。ルーターは、ブラウザ内のグローバルのlocationオブジェクトを使用して動作します。

Angularバージョン9からは、遅延ロードのモジュールそれぞれにあるサービスの新しいインスタンスを提供できます。次のコードはこの機能を`UserService`に加えています。

<code-example path="providers/src/app/user.service.2.ts"  header="src/app/user.service.ts"></code-example>

`providedIn: 'any'`により、すべての即時ロードされたモジュールはシングルトンのインスタンスを共有します。しかし、次の図のように、遅延ロードのモジュールは自身のユニークなインスタンスをそれぞれ取得します。

<img src="generated/images/guide/providers/any-provider.svg" alt="any-provider-scope" class="left">


## コンポーネントでプロバイダーのスコープを制限する

プロバイダーのスコープを制限するもうひとつの方法は、制限したいサービスをコンポーネントの`providers`配列に追加することです。
コンポーネントのプロバイダーとNgModuleのプロバイダーは、おたがいに独立しています。
この方法は、自分自身にサービスを必要とするモジュールを即時ロードしたいときに役立ちます。
コンポーネントにサービスを提供すると、サービスはそのコンポーネントとその子孫だけに制限されます。
同じモジュールにある他のコンポーネントからはアクセスできません。

<code-example path="providers/src/app/app.component.ts" region="component-providers" header="src/app/app.component.ts"></code-example>


## モジュールとコンポーネントのどちらでサービスを提供するか

一般的に、アプリケーション全体で必要ならルートモジュール、提供するサービスのスコープを絞りたいなら遅延ロードされるモジュールでサービスを提供してください。

ルーターはルートレベルで動作するので、プロバイダーをたとえ`AppComponent`であってもコンポーネントに配置すると、ルーターに依存する遅延ロードされるモジュールはそれらを見ることができません。

<!-- KW--Make a diagram here -->
サービスのインスタンスをコンポーネントおよびそのコンポーネントツリー、つまりその子コンポーネントに限定する必要がある場合は、プロバイダーをコンポーネントに登録してください。たとえば、`UserService`のキャッシュのプライベートコピーが必要であるユーザー編集コンポーネント `UserEditorComponent`は、`UserEditorComponent`に`UserService`を登録すべきです。そうすることで、個々の`UserEditorComponent`の新しいインスタンスごとに、自身のキャッシュされたサービスのインスタンスを得ることができます。


<hr>

## NgModuleについてのさらに詳しい情報

あなたはこちらにも興味があるかもしれません:
* [シングルトンサービス](guide/singleton-services)では、このページで取り上げられている概念を詳しく説明しています。
* [モジュールの遅延ロード](guide/lazy-loading-ngmodules)
* [ツリーシェイキング可能なプロバイダー](guide/dependency-injection-providers#tree-shakable-providers)
* [NgModule FAQ](guide/ngmodule-faq)
