# ハイドレーション

## ハイドレーションとは？

ハイドレーションとは、サーバー側でレンダリングされたアプリケーションをクライアント上で復元する処理です。これには、サーバーがレンダリングしたDOM構造の再利用、アプリケーションの状態の永続化、サーバーがすでに取得したアプリケーションデータの転送、その他の処理などが含まれます。

## なぜハイドレーションが重要なのでしょうか？

ハイドレーションは、DOMノードを再生成する余分な作業を避けることで、アプリケーションのパフォーマンスを向上させます。その代わりに、Angularは実行時に既存のDOM要素をアプリケーションの構造に一致させようとし、可能な限りDOMノードを再利用します。その結果、[Core Web Vitals (CWV)](https://web.dev/learn-core-web-vitals/)統計を使って測定できるパフォーマンス向上がもたらされます。たとえば、First-contentful paint [FCP](https://developer.chrome.com/en/docs/lighthouse/performance/first-contentful-paint/)やLargest Contentful Paint ([LCP](https://web.dev/lcp/))、Cumulative Layout Shift ([CLS](https://web.dev/cls/))の削減などです。これらの数値を改善することは、SEOのパフォーマンスなどにも影響します。

ハイドレーションを有効にしていない場合、サーバーサイドでレンダリングされたAngularアプリケーションはアプリケーションのDOMを破棄し再レンダリングするため、目に見えるUIのちらつきが発生する可能性があります。この再レンダリングは[LCP](https://web.dev/lcp/)のような[Core Web Vitals](https://web.dev/learn-core-web-vitals/)に悪影響を与え、レイアウトのずれを引き起こす可能性があります。ハイドレーションを有効にすると、既存のDOMが再利用され、ちらつきを防ぐことができます。

<a id="how-to-enable"></a>

## Angularでハイドレーションを有効にする方法

ハイドレーションを始める前に、サーバーサイドレンダリング（SSR）アプリケーションが必要です。[Angular SSRガイド](/guide/ssr)にしたがって、最初にサーバーサイドレンダリングを有効にしてください。アプリケーションでSSRが動作するようになったら、メインのアプリケーションコンポーネントまたはモジュールにアクセスして、`@angular/platform-browser`から`provideClientHydration`をインポートすることで、ハイドレーションを有効にできます。そして、そのプロバイダーをアプリケーションのブートストラッピング用のプロバイダーリストに追加します。

```typescript
import {
  bootstrapApplication,
  provideClientHydration,
} from '@angular/platform-browser';
...

bootstrapApplication(RootCmp, {
  providers: [provideClientHydration()]
});
```

NgModules を使用している場合は、ルートアプリケーションモジュールのプロバイダーリストに `provideClientHydration` を追加します。

```typescript
import {provideClientHydration} from '@angular/platform-browser';
import {NgModule} from '@angular/core';

@NgModule({
  declarations: [RootCmp],
  exports: [RootCmp],
  bootstrap: [RootCmp],
  providers: [provideClientHydration()],
})
export class AppModule {}
```

<div class="alert is-helpful">

**重要**: `provideClientHydration()` の呼び出しが、**サーバー** でアプリケーションをブートストラップするために使用されるプロバイダーセットにも含まれていることを確認してください。 
デフォルトのプロジェクト構造 (`ng new` コマンドで生成される) をもつアプリケーションでは、ルートの `AppModule` への呼び出しを追加するだけで十分です。このモジュールはサーバーモジュールによってインポートされるので、ルート `AppModule` への呼び出しを追加するだけで十分です。
独自のセットアップを使用する場合は、サーバーの起動設定のプロバイダーリストに `provideClientHydration()` 呼び出しを追加してください。

</div>

以上のステップを踏んでサーバーを立ち上げたら、ブラウザでアプリケーションを読み込みます。

<div class="alert is-helpful">

  おそらく、直接的にDOMを操作している箇所は、Angularによる構築に切り替えるか、`ngSkipHydration`を使用する必要があるでしょう。詳しくは、[制限事項](#constraints)、[直接的なDOM操作](#dom-manipulation)、[特定のコンポーネントに対してハイドレーションをスキップする方法](#ngskiphydration)を参照してください。

</div>

開発モードでアプリケーションを実行中に、ブラウザで開発者ツールを開き、コンソールを表示することで、ハイドレーションが有効になっていることを確認できます。ハイドレーションされたコンポーネントやノードの数など、ハイドレーション関連の統計情報を含むメッセージが表示されるはずです。

<div class="alert is-helpful">
  
Angularは、サードパーティのライブラリに由来するものも含め、ページにレンダリングされたすべてのコンポーネントに基づいて統計情報を計算します。

</div>

<a id="constraints"></a>

## 制限事項

ハイドレーションは、ハイドレーションが有効でない場合には存在しない、いくつかの制限をアプリケーションに課します。アプリケーションは、サーバーとクライアントの両方で同じ DOM 構造を生成しなければなりません。ハイドレーションの処理は、DOMツリーが両方の場所で同じ構造をもつことを期待します。これには、サーバーでのレンダリング中にAngularが生成する空白やコメントノードも含まれます。これらの空白とノードは、サーバー側のレンダリング処理で生成されたHTMLに存在しなければなりません。

<div class="alert is-important">

サーバー側のレンダリング操作によって生成されたHTMLは、サーバーとクライアントの間で**変更してはいけません**。

</div>

サーバーとクライアントのDOMツリー構造の間に不一致がある場合、ハイドレーション処理は、期待されたものと実際にDOMに存在するものを一致させようとする際に問題が発生します。ネイティブのDOM APIを使って直接DOMを操作するコンポーネントは、もっとも一般的な原因です。

<a id="dom-manipulation"></a>

### 直接的なDOM操作

ネイティブの DOM API を使用して DOM を操作したり、`innerHTML` や `outerHTML` を使用したりするコンポーネントがある場合、ハイドレーション処理でエラーが発生する可能性があります。DOM 操作が問題となる具体的な例としては、`document` へのアクセス、特定の要素に対するクエリ、`appendChild` を使用した追加ノードの挿入などがあります。DOM ノードを切り離したり、他の場所に移動させたりすることもエラーになります。

これは、AngularがこのようなDOMの変化に気づかず、ハイドレーションの過程で解決できないためです。Angularはある特定の構造を想定していますが、ハイドレーションしようとすると異なる構造に遭遇します。このミスマッチはハイドレーションの失敗を招き、DOMミスマッチエラーを投げます（[下記参照](#errors)）。

このようなDOM操作を避けるためにコンポーネントをリファクタリングするのがベストです。可能であれば、Angular APIを使ってこの作業を行うようにしましょう。この動作をリファクタリングできない場合は、ハイドレーションに適したソリューションにリファクタリングできるまで、`ngSkipHydration`属性（[後述](#ngskiphydration)）を使用してください。

<a id="valid-html"></a>

### 有効なHTML構造 {@a valid-html-structure}

有効なHTML構造を持たないコンポーネントテンプレートがある場合、ハイドレーションの際にDOMミスマッチエラーが発生する可能性があります。

一例として、この問題でもっともよく見られるケースを紹介します。

* `<tbody>` を持たない `<table>` 
* `<p>` の中の `<div>`
* `<h1>` の中の `<a>`
* `<a>` の中の別の `<a>`

HTMLが有効かどうか不確かな場合は、[構文バリデータ](https://validator.w3.org/)を使ってチェックすることができます。

<a id="preserve-whitespaces"></a>
### 空白保持の設定

ハイドレーション機能を使用する場合、`preserveWhitespaces`のデフォルト設定である`false`を使用することを推奨します。この設定がtsconfigにない場合、値は`false`となり、変更は必要ありません。`preserveWhitespaces:true`をtsconfigに追加して空白の保持を有効にした場合、ハイドレーションの問題が発生する可能性があります。これはまだ完全にサポートされた設定ではありません。

<div class="alert is-helpful">

この設定が、サーバーの `tsconfig.server.json` とブラウザの `tsconfig.app.json` で **一貫して** 設定されていることを確認してください。値が不一致の場合、ハイドレーションが壊れる原因になります。

tsconfigでこの設定を行う場合は、`tsconfig.app.json`にのみ設定することをお勧めします。デフォルトでは、`tsconfig.server.json`がこの設定を継承します。

</div>

<a id="cdn-configuration"></a>
### CDNの最適化

多くのCDNは、レンダリングされたアプリケーションを最適化するために、レンダリングされたDOMから不要と思われるノードをすべて削除する機能を提供しています。コメントノードはAngularの機能に不可欠な部分であり、Hydrationが機能するために重要です。アプリケーションのロードとハイドレーションを確実に行うには、このCDN機能を無効にする必要があります。

CDN最適化が有効でハイドレーションが有効な場合、ページをロードしようとするとエラー[NG0507](https://angular.io/errors/NG0507)が発生します。このエラーが表示された場合、CDN最適化を無効にする必要があります。

### カスタムまたはNoop Zone.jsはまだサポートされていません

ハイドレーションは、アプリケーション内で安定したときにZone.jsから送られる通知に依存します。それにより、Angularはサーバー上でシリアライゼーション処理を開始したり、クライアント上でハイドレーション後のクリーンアップを行い、要求されずに残っているDOMノードを削除したりすることができます。

カスタムまたは "noop" Zone.js 実装を提供すると、"stable" イベントのタイミングが異なり、シリアライズやクリーンアップが早すぎたり遅すぎたりする可能性があります。これはまだ完全にサポートされている設定ではないので、Zone.jsのカスタム実装で`onStable`イベントのタイミングを調整する必要があるかもしれません。


<a id="errors"></a>

## エラー

ノードの不一致や `ngSkipHydration` が無効なホストノードで使用された場合など、ハイドレーションに関連するエラーはいくつかあります。発生する可能性のあるもっとも一般的なエラーのケースは、ネイティブ API を使用して DOM を直接操作した結果、サーバーによってレンダリングされたクライアントの DOM ツリー構造をハイドレーションが見つけられなかったり、一致しなかったりすることです。このタイプのエラーに遭遇する可能性がある他のケースは、前述の[有効なHTML構造](#valid-html)のセクションで述べたとおりです。そのため、テンプレート内のHTMLが有効な構造を使用していることを確認してください。

ハイドレーション関連のエラーに関する完全なリファレンスは、[エラーリファレンスガイド](/errors)を参照してください。

<a id="ngskiphydration"></a>

## 特定コンポーネントのハイドレーションをスキップする方法

コンポーネントによっては、[直接的なDOM 操作](#dom-manipulation) のような前述の問題のために、ハイドレーションを有効にすると正しく動作しない場合があります。回避策として、コンポーネントのタグに `ngSkipHydration` 属性を追加して、コンポーネント全体のハイドレーションをスキップすることができます。

```html
<example-cmp ngSkipHydration />
```

あるいは、ホストバインディングとして `ngSkipHydration` を設定することもできます。

```typescript
@Component({
  ...
  host: {ngSkipHydration: 'true'},
})
class ExampleCmp {}
```

`ngSkipHydration`属性は、Angularにコンポーネント全体とその子のハイドレーションをスキップさせます。この属性を使用すると、コンポーネントはハイドレーションが有効でないかのように動作します。

<div class="alert is-helpful">

これによりレンダリングの問題は解決されますが、このコンポーネント（およびその子コンポーネント）ではハイドレーションの利点が得られないことになります。ハイドレーションをスキップする注釈を削除できるようにするには、ハイドレーションを破るパターン（DOMの直接操作）を避けるようにコンポーネントの実装を調整する必要があります。

</div>

`ngSkipHydration` 属性はコンポーネントのホストノードでのみ使用できます。Angular はこの属性を他のノードに追加するとエラーを投げます。

アプリケーションのルートコンポーネントに `ngSkipHydration` 属性を追加すると、アプリケーション全体のハイドレーションが事実上無効になることに留意してください。この属性の使用には慎重かつ思慮深くあるべきです。これは最終的な回避策として意図されています。ハイドレーションを破壊するコンポーネントは、修正が必要なバグと考えるべきです。

<a id="i18n"></a>

## 国際化

私たちはまだハイドレーションで国際化をサポートしていませんが、サポートする予定です。
現在のところ、Angularはi18nブロックを使用するコンポーネントのハイドレーションをスキップし、
効果的にそれらのコンポーネントを最初から再レンダリングします。

## DOMを操作するサードパーティライブラリ

レンダリングするためにDOM操作に依存するサードパーティ・ライブラリは数多くあります。D3チャートはその代表例です。これらのライブラリはハイドレーションを使用していない状態では動作していましたが、ハイドレーションを有効にするとDOMミスマッチエラーを引き起こす可能性があります。今のところ、これらのライブラリを使用して DOM 不一致エラーが発生した場合は、そのライブラリを使用してレンダリングするコンポーネントに `ngSkipHydration` 属性を追加してください。

@reviewed 2023-08-14
