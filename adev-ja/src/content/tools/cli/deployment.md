# デプロイ

Angularアプリケーションをリモートサーバーにデプロイする用意をする場合、様々なオプションがあります。

## CLIによる自動デプロイ

AngularのCLIコマンドである`ng deploy`はあなたのプロジェクトに紐づいた`deploy` [CLI builder](guide/cli-builder)を実行します。
多数のサードパーティのビルダーが異なるプラットフォームで機能するよう実装しています。
`ng add`によって、それらのいずれかをあなたのプロジェクトに追加できます。

デプロイ機能が入ったパッケージを追加すると、選択されたプロジェクトに対する`deploy`セクションを伴うワークスペースの設定(`angular.json`ファイル)が自動的に更新されます。
その後、そのプロジェクトにデプロイするために`ng deploy`コマンドを使うことが可能です。

例えば、以下のコマンドは[Firebase](https://firebase.google.com/)にプロジェクトを自動的にデプロイできます。

<docs-code language="shell">

ng add @angular/fire
ng deploy

</docs-code>

コマンドは対話的です。
このケースでは、Firebaseアカウントを持っているか作成しなくてはならず、それを使用して認証しなくてはなりません。
あなたのアプリケーションをビルドし、プロダクションの資材をFirebaseにアップロードする前に、デプロイするFirebaseプロジェクトを選択するよう、本コマンドはあなたを指示します。

以下の表では異なるプラットフォームのデプロイ機能を実装するツールをリストアップしています。
各パッケージの`deploy`コマンドは異なるコマンドラインオプションを要求します。
以下のパッケージ名に関連付けられたリンクをたどることで、より詳細を読むことができます。

| デプロイ先                                                        | セットアップコマンド                                                                       |
|:---                                                               |:---                                                                                  |
| [Firebase hosting](https://firebase.google.com/docs/hosting)      | [`ng add @angular/fire`](https://npmjs.org/package/@angular/fire)                           |
| [Vercel](https://vercel.com/solutions/angular)                    | [`vercel init angular`](https://github.com/vercel/vercel/tree/main/examples/angular) |
| [Netlify](https://www.netlify.com)                                | [`ng add @netlify-builder/deploy`](https://npmjs.org/package/@netlify-builder/deploy)       |
| [GitHub pages](https://pages.github.com)                          | [`ng add angular-cli-ghpages`](https://npmjs.org/package/angular-cli-ghpages)               |
| [Amazon Cloud S3](https://aws.amazon.com/s3/?nc2=h_ql_prod_st_s3) | [`ng add @jefiozie/ngx-aws-deploy`](https://www.npmjs.com/package/@jefiozie/ngx-aws-deploy) |

もし自己管理されたサーバーにデプロイする場合や、お気に入りのクラウドプラットフォームのビルダーがない場合、`ng deploy`コマンドを使うことを許容する[ビルダーを作成する](tools/cli/cli-builder)か、アプリケーションを手動でデプロイする方法を学ぶためのこのガイドを読み通すか、どちらかの方法を取る事が可能です。

## リモートサーバーへの手動デプロイ

あなたのアプリケーションを手動でデプロイする場合、プロダクションビルドを作成し、出力ディレクトリをwebサーバーかコンテンツデリバリネットワーク(CDN)にコピーしてください。
デフォルトでは、`ng build`は`production`設定を使用します。
ビルド設定をカスタマイズする場合、[プロダクション最適化](tools/cli/deployment#production-optimizations)がデプロイの前に適用されていることを確認したいかもしれません。

`ng build`はデフォルトで`dist/my-app/`にビルドの中間生成物を出力しますが、このパスは`@angular-devkit/build-angular:browser`ビルダーの`outputPath`で設定可能です。
このディレクトリをサーバーにコピーし、そのディレクトリでサービスを動かすよう設定してください。

これは最小限のデプロイの解決法ですが、あなたのアプリケーションをサーバーで正しくサービス提供するためには少数の必要条件があります。

## サーバーの設定

このセクションはサーバーであなたのAngularアプリケーションを実行するのに必要かもしれない設定の変更について取り上げます。

### ルーティングされたアプリケーションは`index.html`にフォールバックしなければなりません。

クライアントサイドレンダリングのAngularアプリケーションはすべてのコンテンツが静的でビルド時に生成されるため、静的HTMLサーバーによるサービス提供のための候補としては完璧です。

もしアプリケーションがAngularのルーターを使っているならば、持っていないファイルを要求した時、アプリケーションのホストページ(`index.html`)を返すよう設定しなければなりません。

ルーティングされたアプリケーションは「ディープリンク」をサポートするべきです。
*ディープリンク*はアプリケーションの中のコンポーネントへの経路を指定したURLです。
例えば、`http://my-app.test/users/42`は`id`42のユーザーを表示するユーザー詳細ページへの*ディープリンク*です。

ユーザーが最初にindexページをロードし、それから起動中のクライアント内からそのURLに移動するのは問題ありません。
Angularのルーターは*クライアントサイド*でナビゲーションを実行し、新しいHTMLを要求しません。

しかし、電子メール内のディープリンクをクリックしたり、ブラウザのアドレスバーにディープリンクを入力したり、既にディープリンクに紐づけられたページをブラウザでリフレッシュするときさえも、実行しているアプリケーションの*外部*ですべてブラウザ自身によって処理されます。
Angularのルーターを迂回して、ブラウザは`/users/42`に対するサーバーへの直接のリクエストを作成します。

静的なサーバーは`http://my-app.test/`に対するリクエストを受け取ると決まって`index.html`を返します。
しかし、デフォルトでほとんどサーバーは`index.html`を代わりに返すよう設定されて*いないかぎり*`http://my-app.test/users/42`を拒否して`404 - Not Found`エラーを返します。
フォールバックルートを設定するか、サーバー上で404ページを`index.html`にする設定することで、Angularはディープリンクに関するサービスを提供し、正しいルートを表示できます。
いくつかのサーバーはこのフォールバックの挙動を"Single-Page Application"(SPA)モードと呼びます。

一度ブラウザがアプリケーションをロードすると、Angularのルーターはどのページにあるのかを判断するためにURLを読み込み、`/users/42`を正しく表示しようとします。

`http://my-app.test/does-not-exist`のような"本当の"404ページについて、サーバーはいかなる追加の設定も必要としません。
[Angularのルーターで実装された404ページ](guide/routing/common-router-tasks#displaying-a-404-page)は正しく表示されるでしょう。

### 異なるサーバーからデータをリクエストする(CORS)

アプリケーション自身のホストサーバー以外のサーバーにネットワークリクエストを行う際、Web開発者は[*クロスオリジンリソース共有*](https://developer.mozilla.org/docs/Web/HTTP/CORS "クロスオリジンリソース共有")エラーに遭遇するかもしれません。
ブラウザはサーバーが明示的に許可していない限りそのようなリクエストを禁止します。

これらのエラーに関してAngularまたはクライアントアプリケーションでできることは何もありません。
*サーバー*はアプリケーションのリクエストを受け付けるよう設定されていなければなりません。
特定のサーバーでCORSを有効にする方法は[enable-cors.org](https://enable-cors.org/server.html "CORSサーバーの有効化")を読んでください。

## プロダクションの最適化

`ng build`は特に設定しない限り`production`設定を使います。この設定はビルド最適化機能を有効にします。

| 機能                                                                  | 詳細                                                                                          |
|:---                                                                   |:---                                                                                           |
| [事前(AOT)コンパイル](guide/aot-compiler)                             | Angularコンポーネントのテンプレートの事前コンパイル。                                         |
| [プロダクションモード](tools/cli/deployment#development-only-features)| 実行時のパフォーマンスを最高にするためのアプリケーションの最適化                              |
| バンドル                                                              | 多数のアプリケーションおよびライブラリを連結してデプロイされるファイルを最小限の数にする。    |
| 最小化                                                                | 余分なホワイトスペース、コメントおよびオプショナルなトークンを取り除く。                      |
| マングリング                                                          | 関数、クラスおよび変数の名前を変更し、短い任意の識別子を使用する。                            |
| デッドコード削除                                                      | 参照されないモジュールおよび未使用コードを削除する。                                          |

CLIのビルドオプションとそれらの効果についてより多く知るために[`ng build`](cli/build)を参照してください。

### 開発時のみの機能

`ng serve`を使ってローカルでアプリケーションを起動するとき、Angularは開発用の設定を使用することで、
実行時に以下が使用可能になります:

* [`expression-changed-after-checked`](errors/NG0100)の検出のような安全な追加のチェック。
* より詳細なエラーメッセージ。
* [デバッグ関数](api#core-global)および[Angular DevTools](tools/devtools)をサポートするグローバルな`ng`変数のような追加のデバッグユーティリティ。

これらの機能は開発中は便利ですが、アプリケーションに追加のコードが必要で、プロダクションでは望まれません。
エンドユーザーのためのバンドルサイズにネガティブな影響を与えないよう、これらの機能を安全に使うために、Angular CLIは
プロダクションをバンドリングする際のバンドルから開発時のみのコードを削除します。

`ng build`によるアプリケーションのビルドでは最適なバンドルサイズにするために出力からこれらの機能を取り除く`production`をデフォルトで用います。

## `--deploy-url`

`--deploy-url`は画像、スクリプト、スタイルシートといった資材のための関連するURLを解決するためのベースとなるパスを*コンパイル*時に指定するのに使われるコマンドラインオプションです。

<docs-code language="shell">

ng build --deploy-url /my/assets

</docs-code>

`--deploy-url`の効果と目的は[`<base href>`](guide/routing/common-router-tasks)と重なります。両者とも初期のスクリプト、スタイルシート、遅延して読み込まれるスクリプト、cssリソースのために使用できます。

`<base href>`実行時に一か所で定義できる<base href>`とは違い、`--deploy-url`はビルド時にアプリケーションでハードコーディングされる必要があります。
可能であれば`<base href>`の方が好ましいです。
